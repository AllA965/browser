## 1. 登录功能接入文档说明

软件端通过网页端同步登录流程[（示例代码）](#4-登录示例代码)

1.请求检查是否登录接口，如果没有登录则跳转到网页端登录
2.生成临时会话id，拼接成登录url,浏览器打开url
3.轮询请求获取登录令牌接口


接口文档地址:
在线：https://docs.apipost.net/docs/detail/590ee4645c51000?target_id=10e8f79df0c957
本地：'鲲穹软件登录功能接口.md'

---

## 2. 鲲穹软件登录功能接口

# 登录相关

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2025-12-31 14:10:36

> 更新时间: 2025-12-31 14:11:06

```text
暂无描述
```

**目录Header参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| 暂无参数 |

**目录Query参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| 暂无参数 |

**目录Body参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| 暂无参数 |

**目录认证信息**

> 继承父级

**Query**

## 检查是否登录

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2025-12-31 14:07:57

> 更新时间: 2025-12-31 14:30:03

```text
暂无描述
```

**接口状态**

> 开发中

**接口URL**

> https://api-web.kunqiongai.com/user/check_login

**请求方式**

> POST

**Content-Type**

> urlencoded

**请求Body参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| token | 6143a416-e9be-4d58-8b77-450d5ad866d2 | string | 是 | 登录令牌 |

**认证方式**

> 继承父级

**响应示例**

* 成功(200)

```javascript
{"code":1,"msg":"已登录","time":1767162567,"data":[]}
```

| 参数名 | 示例值 | 参数类型 | 参数描述 |
| --- | --- | ---- | ---- |
| code | 1 | number | 状态值(1为成功，其他值为失败) |
| msg | 成功 | string | 消息描述 |
| time | 1767162006 | number | - |
| data | - | object | - |

* 失败(404)

```javascript
暂无数据
```

**Query**

## 获取登录令牌token

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2025-12-31 13:42:53

> 更新时间: 2026-01-03 16:14:24

```text
暂无描述
```

**接口状态**

> 开发中

**接口URL**

> https://api-web.kunqiongai.com/user/desktop_get_token

**请求方式**

> POST

**Content-Type**

> urlencoded

**请求Body参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| client_type | desktop | string | 是 | 客户端类型(固定值:desktop) |
| client_nonce | b71489c5fec4d06b84-asdfaf | string | 是 | 临时会话id |

**认证方式**

> 继承父级

**响应示例**

* 成功(200)

```javascript
{"code":1,"msg":"成功","time":1767161841,"data":{"token":"6143a416-e9be-4d58-8b77-450d5ad866d2"}}
```

| 参数名 | 示例值 | 参数类型 | 参数描述 |
| --- | --- | ---- | ---- |
| code | 1 | number | 状态值(1为成功，其他值为失败) |
| msg | 成功 | string | 消息描述 |
| time | 1767161841 | number | - |
| data | - | object | - |
| data.token | 6143a416-e9be-4d58-8b77-450d5ad866d2 | string | 登录令牌 |

* 失败(404)

```javascript
暂无数据
```

**Query**

## 获取用户基本信息

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2025-12-31 14:09:05

> 更新时间: 2025-12-31 14:28:58

```text
暂无描述
```

**接口状态**

> 开发中

**接口URL**

> https://api-web.kunqiongai.com/soft_desktop/get_user_info

**请求方式**

> POST

**Content-Type**

> urlencoded

**请求Header参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| token | 6143a416-e9be-4d58-8b77-450d5ad866d2 | string | 是 | 登录令牌 |

**认证方式**

> 继承父级

**响应示例**

* 成功(200)

```javascript
{"code":1,"msg":"成功","time":1767162491,"data":{"user_info":{"avatar":"https:\/\/iamge.kunqiongai.com\/avatar\/touxiang.jpg","nickname":"kqai_180rKXFm5390"}}}
```

| 参数名 | 示例值 | 参数类型 | 参数描述 |
| --- | --- | ---- | ---- |
| code | 1 | number | 状态值(1为成功，其他值为失败) |
| msg | 成功 | string | 消息描述 |
| time | 1767162491 | number | - |
| data | - | object | - |
| data.user_info | - | object | 用户信息 |
| data.user_info.avatar | https://iamge.kunqiongai.com/avatar/touxiang.jpg | string | 头像 |
| data.user_info.nickname | kqai_180rKXFm5390 | string | 昵称 |

* 失败(404)

```javascript
暂无数据
```

**请求Header参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| token | 6143a416-e9be-4d58-8b77-450d5ad866d2 | string | 是 | 登录令牌 |

**Query**

## 退出登录

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2026-01-03 16:14:17

> 更新时间: 2026-01-03 16:15:30

```text
暂无描述
```

**接口状态**

> 开发中

**接口URL**

> https://api-web.kunqiongai.com/logout

**请求方式**

> POST

**Content-Type**

> urlencoded

**请求Header参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| token | 87eceba1-da8c-4d28-b567-c11e126a42cb | string | 是 | 登录令牌 |

**认证方式**

> 继承父级

**响应示例**

* 成功(200)

```javascript
{"code":1,"msg":"成功","time":1767428007,"data":null}
```

| 参数名 | 示例值 | 参数类型 | 参数描述 |
| --- | --- | ---- | ---- |
| code | 1 | number | 状态值(1成功,其他值失败) |
| msg | 成功 | string | - |
| time | 1767428007 | number | - |
| data | - | null | - |

* 失败(404)

```javascript
暂无数据
```

**请求Header参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| token | 87eceba1-da8c-4d28-b567-c11e126a42cb | string | 是 | 登录令牌 |

**Query**

## 获取网页端登录地址

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2026-01-05 14:19:43

> 更新时间: 2026-01-05 14:19:45

```text
暂无描述
```

**接口状态**

> 开发中

**接口URL**

> https://api-web.kunqiongai.com/soft_desktop/get_web_login_url

**请求方式**

> POST

**Content-Type**

> urlencoded

**认证方式**

> 继承父级

**响应示例**

* 成功(200)

```javascript
{"code":1,"msg":"成功","time":1767593950,"data":{"login_url":"http:\/\/111.229.158.50:1388\/login"}}
```

| 参数名 | 示例值 | 参数类型 | 参数描述 |
| --- | --- | ---- | ---- |
| code | 1 | number | 状态值(1成功,其他值失败) |
| msg | 成功 | string | - |
| time | 1767593950 | number | - |
| data | - | object | - |
| data.login_url | http://111.229.158.50:1388/login | string | 网页端登录地址 |

* 失败(404)

```javascript
暂无数据
```

**Query**

---

## 3. 鲲穹软件广告功能接口

# 获取广告

> 创建人: 希波托厄

> 更新人: 希波托厄

> 创建时间: 2026-01-04 15:50:20

> 更新时间: 2026-01-04 15:52:45

```text
暂无描述
```

**接口状态**

> 开发中

**接口URL**

> https://api-web.kunqiongai.com/soft_desktop/get_adv

**请求方式**

> POST

**Content-Type**

> urlencoded

**请求Body参数**

| 参数名 | 示例值 | 参数类型 | 是否必填 | 参数描述 |
| --- | --- | ---- | ---- | ---- |
| soft_number | 10019 | string | 是 | 软件编号(获取地址https://image.kunqiongai.com/soft_list.html) |
| adv_position | adv_position_01 | string | 是 | 广告位置(前缀"adv_position_"；如adv_position_01，后面的编号需提前约定) |

**认证方式**

> 继承父级

**响应示例**

* 成功(200)

```javascript
{"code":1,"msg":"成功","time":1767512902,"data":[{"soft_number":10019,"adv_position":"adv_position_01","adv_url":"https:\/\/image.kunqiongai.com\/adv\/demo1.png","target_url":"http:\/\/111.229.158.50:1388\/","width":1920,"height":230}]}
```

| 参数名 | 示例值 | 参数类型 | 参数描述 |
| --- | --- | ---- | ---- |
| code | 1 | number | 状态值(1成功,其他值失败) |
| msg | 成功 | string | - |
| time | 1767512902 | number | - |
| data | - | array | - |
| data.soft_number | 10019 | number | 软件编号(获取地址https://image.kunqiongai.com/soft_list.html) |
| data.adv_position | adv_position_01 | string | 广告位置(前缀adv_position_，如adv_position_01，后面的编号需提前约定) |
| data.adv_url | https://image.kunqiongai.com/adv/demo1.png | string | 广告资源地址 |
| data.target_url | http://111.229.158.50:1388/ | string | 广告对应跳转地址 |
| data.width | 1920 | number | 宽 |
| data.height | 230 | number | 高 |

* 失败(404)

```javascript
暂无数据
```

**Query**

---

## 4. 登录示例代码

```python
import uuid
import time
import hmac
import hashlib
import base64
import json
import requests
import webbrowser
import threading

# 客户端与服务端约定的密钥（需安全存储，不可硬编码在代码中！）
# 实际环境中可从配置文件/系统密钥库读取，
SECRET_KEY = b"7530bfb1ad6c41627b0f0620078fa5ed"
#接口基础地址
API_BASE_URL = "https://api-web.kunqiongai.com"

def get_web_login_url():
    """获取网页端登录地址"""
    url = API_BASE_URL + "/soft_desktop/get_web_login_url"
    response = requests.post(url)
    result = response.json()
    if result["code"] == 1:
        return result["data"]["login_url"]
    else:
        raise Exception(f"获取登录地址失败：{result['msg']}")

def generate_signed_nonce():
    """
    生成带签名的临时会话ID（nonce）
    返回：字典，包含nonce、timestamp、signature
    """
    # 1. 生成随机nonce（基础唯一标识）
    nonce = str(uuid.uuid4()).replace("-", "")
    
    # 2. 生成时间戳（秒级），用于防重放攻击
    timestamp = int(time.time())
    
    # 3. 构造待签名的字符串（nonce + 时间戳，用分隔符区分，避免拼接歧义）
    message = f"{nonce}|{timestamp}".encode("utf-8")
    
    # 4. HMAC-SHA256签名（算法与服务端一致）
    hmac_obj = hmac.new(SECRET_KEY, message, hashlib.sha256)
    signature = base64.b64encode(hmac_obj.digest()).decode("utf-8")  # 转base64方便传输
    
    # 5. 返回组合数据
    signed_nonce = {
        "nonce": nonce,
        "timestamp": timestamp,
        "signature": signature
    }
    return signed_nonce

def encode_signed_nonce(signed_nonce):
    """将带签名的nonce编码为URL安全的字符串，方便拼接在登录URL中"""
    # 先转为JSON字符串，再base64编码（避免URL转义问题）
    json_str = json.dumps(signed_nonce, separators=(",", ":"))  # 紧凑格式
    url_safe_str = base64.b64encode(json_str.encode("utf-8")).decode("utf-8")
    # 替换base64中的URL不安全字符
    url_safe_str = url_safe_str.replace("+", "-").replace("/", "_").rstrip("=")
    return url_safe_str

# 测试生成
# if __name__ == "__main__":
#     signed_nonce = generate_signed_nonce()
#     print("带签名的nonce原始数据：", signed_nonce)
    
#     # 编码为URL安全字符串，用于拼接登录URL
#     encoded_nonce = encode_signed_nonce(signed_nonce)
#     print("URL安全编码后的nonce：", encoded_nonce)
    
#     # 拼接登录URL
#     login_url = f"https://www.kunqiongai.com/login?client_type=desktop&client_nonce={encoded_nonce}"
#     print("最终登录URL：", login_url)





# 全局变量
login_token = None
poll_stop_event = threading.Event()

def poll_token(encoded_nonce, timeout=300):
    """轮询服务端获取Token"""
    global login_token
    start_time = time.time()
    poll_url = API_BASE_URL + "/user/desktop_get_token"
    
    while time.time() - start_time < timeout and not poll_stop_event.is_set():
        try:
            response = requests.post(
                poll_url,
                params={"client_type": "desktop", "client_nonce": encoded_nonce},
                timeout=5
            )
            response.raise_for_status()
            result = response.json()
            
            if result["code"] == 1:
                login_token = result["data"]["token"]
                #本地保存token，供后续使用
                print("登录成功，Token：", login_token)
                return
            else:
                print(f"轮询异常：{result['msg']}")
                time.sleep(2)
        except Exception as e:
            print(f"轮询失败：{e}")
            time.sleep(2)
    
    raise TimeoutError("登录超时")

#检查是否登录
def check_login():
    """检查是否登录"""
    if login_token:
        #请求检查是否登录接口
        check_url = API_BASE_URL + "/user/check_login"
        # Body请求参数（urlencoded）
        data = {
            "token": login_token
        }
        response = requests.post(check_url, data=data)
        result = response.json()
        if result["code"] == 1:
            print("已登录")
            return True
        else:
            print(f"登录检查异常：{result['msg']}")
            return False

    else:
        print("未登录")
        return False

def login_flow():
    """完整登录流程"""
    # 1. 生成带签名的nonce
    signed_nonce = generate_signed_nonce()
    encoded_nonce = encode_signed_nonce(signed_nonce)

    # 2. 获取网页端登录地址
    web_login_url = get_web_login_url()

    # 3. 启动轮询线程
    poll_thread = threading.Thread(target=poll_token, args=(encoded_nonce,))
    poll_thread.daemon = True
    poll_thread.start()

    # 4. 打开登录网页（携带encoded_nonce）
    login_url = f"{web_login_url}?client_type=desktop&client_nonce={encoded_nonce}"
    webbrowser.open(login_url)
    print("已打开浏览器，请完成登录...")
    
    # 4. 等待轮询完成
    poll_thread.join(timeout=300)
    
    if not login_token:
        raise Exception("登录失败")

if __name__ == "__main__":
    try:
        if check_login():
            print("已登录，跳过登录流程")
            exit()
        login_flow()
    except Exception as e:
        print(f"登录异常：{e}")
        poll_stop_event.set()
```
